# 微信云托管部署指南

微信云托管（WeChat Cloud Hosting）是基于容器的云原生部署方案，特别适合微信小程序项目。它自带免鉴权、免备案域名和 HTTPS 环境。

## 1. 准备工作

1. 进入 [微信云托管控制台](https://cloud.weixin.qq.com/)。
2. 使用你的小程序管理员微信扫码登录。
3. 开通环境（新用户通常有 3 个月免费额度，无需绑卡，微信支付结算）。

## 2. 部署数据库 (PostgreSQL)

1. 在左侧菜单点击 **数据库**。
2. 创建一个 **PostgreSQL 实例**。
3. 创建完成后，记录 **内网连接地址**（Endpoint）、端口、用户名和密码。

## 3. 一键部署全栈服务 (推荐)

借助项目根目录下的统一 `Dockerfile`，你可以将前端 H5 和 Go 后端打包在一起部署。

### 部署步骤

1. 点击 **服务管理** -> **创建服务**。
2. 服务名称建议：`baby-app`。
3. **部署方式**：选择 **代码库部署**（推荐关联 GitHub）。
4. **服务设置**：
    - **端口**: 设置为 `80` (必须与 Dockerfile 中的 `EXPOSE` 保持一致)。
    - **目标目录**: 留空（代表项目根目录）。
    - **Dockerfile 名称**: `Dockerfile`。
5. **环境变量**:
    - 点击 **高级设置** -> **环境变量**。
    - 添加数据库和 Redis 的连接信息（使用内网 Endpoint）。
    - 建议添加 `GIN_MODE=release`。
6. **发布**: 点击发布。云托管会自动构建镜像并上线。

## 4. 为什么要在云托管使用统一部署？

1. **解决 404**：Go 后端已经内置了单页应用路由支持，即使在 H5 页面刷新也不会报错。
2. **免域名/免备案**：云托管提供的公网域名可以直接访问全栈应用。
3. **资源节省**：只需运行一个容器服务，充分利用微信云托管的免费额度。

## 4. 部署 Redis (可选)

微信云托管暂不直接提供原生 Redis 托管，你有两种方案：
1. **容器自建**：利用云托管创建一个新服务跑 Redis 容器。
2. **外部接入**：接入外部（如腾讯云 Redis）的内网私有网络。
*对于初期小型项目，若只用于缓存，可以先在后端代码中使用内存缓存或通过容器自建。*

## 5. 获取连接信息并配置环境变量

由于你是第一次部署，需要先在控制台手动创建数据库和缓存资源：

### 第一步：创建数据库 (PostgreSQL)
1. 在左侧菜单点击 **MySQL** (部分版本显示为数据库)。
2. 点击 **立即开通** 或 **创建实例**。
3. **重要**：选择版本时，寻找支持 **PostgreSQL** 或 **TDSQL-C (PostgreSQL版)** 的选项。
4. 创建成功后，进入实例详情页，记录：
   - **内网地址** (Endpoint，类似于 `gz-cdb-xxx.sql.tencentcdb.com`)
   - **端口** (默认 5432)
   - **用户名** (通常是 root 或 postgres)
   - **密码** (你设置的密码)
   - **数据库名** (创建一个名为 `nutri_baby` 的库)

### 第二步：创建缓存 (Redis)
由于云托管没有直接的 Redis 按钮，我们需要“以服代仓”：
1. 点击 **服务管理** -> **创建服务**。
2. 名称填 `redis`。
3. 部署方式选 **镜像部署**，镜像地址填：`redis:alpine`。
4. 部署完成后，记录服务名 `redis`，端口默认为 `6379`。

### 第三步：填入环境变量 (API 服务)
回到你的 `baby-app` 服务设置的 **高级设置** -> **环境变量**，逐一添加：

| Key | Value (示例) |
| :--- | :--- |
| `DATABASE_HOST` | `你的数据库内网地址` |
| `DATABASE_PORT` | `5432` |
| `DATABASE_USER` | `postgres` |
| `DATABASE_PASSWORD` | `你的数据库密码` |
| `DATABASE_DBNAME` | `nutri_baby` |
| `REDIS_HOST` | `redis` |
| `REDIS_PORT` | `6379` |
| `JWT_SECRET` | `随便填一串乱码` |
| `GIN_MODE` | `release` |

## 6. 小程序端调用
... (后续相同)
